<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Fila - Amaral Barbearia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-anton { font-family: 'Anton', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .barber-card, .specific-customer-item { transition: all 0.2s ease-in-out; }
        .specific-customer-item:hover { background-color: #d97706; }
        /* Switch Toggle CSS */
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #f59e0b; }
        input:checked + .slider:before { transform: translateX(22px); }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <audio id="notification-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_2433fe150b.mp3" preload="auto"></audio>

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
        <div class="text-center"><svg class="animate-spin h-10 w-10 text-amber-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p>Carregando...</p></div>
    </div>
    
    <button id="show-login-btn" class="fixed top-4 right-4 bg-gray-700 p-3 rounded-full hover:bg-gray-600 z-30">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-500"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
    </button>
    
    <div id="password-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-40">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm border-t-4 border-amber-500">
            <h3 class="text-2xl font-bold text-center mb-6">Acesso Administrativo</h3>
            <div class="space-y-4">
                <input type="password" id="password-input" placeholder="Senha" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-amber-500">
                <p id="password-error" class="text-red-500 text-sm text-center h-4"></p>
                <button id="submit-password-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-black font-bold py-3 px-4 rounded-lg">Entrar</button>
                <button class="cancel-modal-btn w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg mt-2">Cancelar</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8 text-center">
            <img src="https://i.imgur.com/YQXIOsI.png" alt="Logo Amaral Barbearia" class="h-28 mx-auto mb-4">
            <h1 class="font-anton text-6xl tracking-wider text-amber-500">AMARAL BARBEARIA</h1>
        </header>

        <main>
            <div id="tv-view" class="view active">
                 <p class="text-center text-gray-400 mb-8">Acompanhe a Fila</p>
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border-t-4 border-amber-500 w-full"><h2 class="text-2xl font-bold mb-4 border-b-2 border-amber-500 pb-2 text-white">üíà Em Atendimento</h2><div id="serving-now-list" class="space-y-4"></div></div>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border-t-4 border-amber-500 w-full"><h2 class="text-2xl font-bold mb-4 border-b-2 border-amber-500 pb-2 text-white">‚è≥ Fila de Espera</h2><ol id="queue-list-display" class="space-y-3"></ol></div>
                </div>
            </div>
            
            <div id="kiosk-view" class="view">
                 <div class="w-full max-w-md mx-auto bg-gray-800 p-8 sm:p-12 rounded-xl shadow-2xl border-t-4 border-amber-500 text-center">
                    <h2 class="text-2xl font-bold text-center mb-4 text-white">Bem-vindo!</h2>
                    <p class="text-center text-gray-400 mb-6">Digite seu nome e escolha sua prefer√™ncia.</p>
                    <div class="space-y-4">
                        <input type="text" id="kiosk-customer-name" placeholder="Seu nome completo" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <select id="kiosk-preferred-barber" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                           <option value="any">Qualquer Barbeiro</option>
                           <!-- Barbeiros ser√£o populados aqui -->
                        </select>
                        <button id="kiosk-join-queue-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-black font-bold py-4 px-4 rounded-lg shadow-lg text-xl">Entrar na Fila</button>
                    </div>
                    <div id="wait-time-display" class="text-amber-400 mt-6 h-6 text-lg font-semibold"></div>
                    <p id="kiosk-customer-feedback" class="text-center text-green-400 mt-2 h-6 text-lg"></p>
                </div>
            </div>

            <div id="admin-view" class="view">
                <p class="text-center text-gray-400 mb-4">Painel de Controle</p>
                <div class="text-center mb-8 space-x-4">
                     <button id="go-to-tv-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">Ver Tela da TV</button>
                     <button id="go-to-kiosk-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Tela de Cliente</button>
                     <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">Sair do Painel</button>
                </div>

                <div class="bg-gray-800 p-4 rounded-lg max-w-sm mx-auto mb-12">
                    <div class="flex items-center justify-center gap-4">
                        <span class="font-semibold">Exibir Estimativa de Tempo:</span>
                        <label class="switch">
                            <input type="checkbox" id="toggle-estimation-btn">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="mt-8">
                    <div class="text-center mb-6"><h2 class="text-3xl font-bold text-amber-500">Gerenciar Barbeiros</h2><p class="text-gray-400">Pr√≥ximo cliente: <span id="next-in-queue-barber" class="font-bold text-xl text-white">Ningu√©m</span></p></div>
                    <div class="text-center mb-8"><button id="add-barber-btn" class="bg-amber-500 hover:bg-amber-600 text-black font-bold py-2 px-6 rounded-lg">Adicionar Barbeiro</button></div>
                    <div id="barbers-panel" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
                <div class="mt-16">
                    <div class="text-center mb-6">
                         <h3 class="text-3xl font-bold text-amber-500">Hist√≥rico de Atendimentos</h3>
                         <div id="history-stats" class="mt-2 text-gray-300"></div>
                         <button id="clear-history-btn" class="mt-4 bg-red-800 hover:bg-red-700 text-white text-sm font-semibold py-2 px-4 rounded-lg" title="Limpar Hist√≥rico">Limpar Hist√≥rico</button>
                    </div>
                    <div id="history-list-container" class="bg-gray-800 p-6 rounded-xl shadow-2xl border-t-4 border-amber-500 max-w-4xl mx-auto"></div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="specific-customer-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-40"><div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md border-t-4 border-amber-500"><h3 class="text-2xl font-bold text-center mb-6">Escolher Cliente da Fila</h3><div id="specific-customer-list" class="space-y-2 max-h-64 overflow-y-auto mb-6"></div><button class="cancel-modal-btn w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg">Cancelar</button></div></div>
    <div id="add-barber-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-40"><div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm border-t-4 border-amber-500"><h3 class="text-2xl font-bold text-center mb-6">Adicionar Novo Barbeiro</h3><div class="space-y-4"><input type="text" id="new-barber-name" placeholder="Nome do Barbeiro" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white"><p id="add-barber-error" class="text-red-500 text-sm text-center h-4"></p><button id="save-barber-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">Salvar</button><button class="cancel-modal-btn w-full bg-gray-600 hover:bg-gray-700 font-semibold py-2 px-4 rounded-lg">Cancelar</button></div></div></div>
    <div id="remove-barber-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-40"><div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm border-t-4 border-amber-500"><h3 class="text-2xl font-bold text-center mb-6">Confirmar Remo√ß√£o</h3><p id="remove-barber-text" class="text-center text-gray-300 mb-6"></p><div class="flex gap-4"><button class="cancel-modal-btn w-full bg-gray-600 hover:bg-gray-700 font-semibold py-2 px-4 rounded-lg">Cancelar</button><button id="confirm-remove-barber-btn" class="w-full bg-red-600 hover:bg-red-700 font-bold py-3 px-4 rounded-lg">Confirmar</button></div></div></div>
    <div id="clear-history-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-40"><div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm border-t-4 border-amber-500"><h3 class="text-2xl font-bold text-center mb-6">Confirmar A√ß√£o</h3><p class="text-center text-gray-300 mb-6">Tem certeza que deseja apagar TODO o hist√≥rico de atendimentos? Esta a√ß√£o n√£o pode ser desfeita.</p><div class="flex gap-4"><button class="cancel-modal-btn w-full bg-gray-600 hover:bg-gray-700 font-semibold py-2 px-4 rounded-lg">Cancelar</button><button id="confirm-clear-history-btn" class="w-full bg-red-600 hover:bg-red-700 font-bold py-3 px-4 rounded-lg">Apagar Hist√≥rico</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, onSnapshot, collection, query, orderBy, limit, addDoc, serverTimestamp, deleteDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDHSIP0Ko808esMuRt0AIQ0Ujhh6hL8ySo",
          authDomain: "barberamaral-e10a4.firebaseapp.com",
          projectId: "barberamaral-e10a4",
          storageBucket: "barberamaral-e10a4.appspot.com",
          messagingSenderId: "617102577968",
          appId: "1:617102577968:web:2caa50df50518ee2f578f5",
          measurementId: "G-66VFX9JERR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const queueCollectionPath = `artifacts/${firebaseConfig.projectId}/public/data/queue`;
        const barbersCollectionPath = `artifacts/${firebaseConfig.projectId}/public/data/barbers`;
        const historyCollectionPath = `artifacts/${firebaseConfig.projectId}/public/data/history`;

        // --- L√ìGICA DE ESTADO E NAVEGA√á√ÉO ---
        const ADMIN_PASSWORD = "AmaralAdmin"; 
        let isAdminAuthenticated = false;
        let isEstimationEnabled = localStorage.getItem('estimationEnabled') === 'true';
        let dynamicAverageTime = 25;
        let barbersCache = {};
        
        let currentQueueSize = 0;
        let availableBarbersCount = 0;

        const passwordModal = document.getElementById('password-modal');
        const showLoginBtn = document.getElementById('show-login-btn');
        const estimationToggle = document.getElementById('toggle-estimation-btn');
        estimationToggle.checked = isEstimationEnabled;
        
        window.switchView = (viewId) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            showLoginBtn.style.display = (viewId === 'admin-view') ? 'none' : 'block';
        };

        showLoginBtn.addEventListener('click', () => {
            if (isAdminAuthenticated) switchView('admin-view');
            else {
                passwordModal.classList.add('active');
                document.getElementById('password-input').focus();
            }
        });

        document.getElementById('submit-password-btn').addEventListener('click', () => {
            if (document.getElementById('password-input').value === ADMIN_PASSWORD) {
                isAdminAuthenticated = true;
                passwordModal.classList.remove('active');
                switchView('admin-view');
            } else {
                document.getElementById('password-error').textContent = 'Senha incorreta.';
            }
        });
        
        document.getElementById('logout-btn').addEventListener('click', () => {
            isAdminAuthenticated = false;
            switchView('tv-view');
        });
        
        estimationToggle.addEventListener('change', (e) => {
            isEstimationEnabled = e.target.checked;
            localStorage.setItem('estimationEnabled', isEstimationEnabled);
        });

        document.getElementById('go-to-kiosk-btn').addEventListener('click', () => switchView('kiosk-view'));
        document.getElementById('go-to-tv-btn').addEventListener('click', () => switchView('tv-view'));

        // --- L√ìGICA DOS MODAIS ---
        const allModals = document.querySelectorAll('.modal');
        document.querySelectorAll('.cancel-modal-btn').forEach(btn => btn.addEventListener('click', (e) => e.target.closest('.modal').classList.remove('active')));
        
        let activeBarberId = null;
        let barberToRemoveId = null;

        document.getElementById('add-barber-btn').addEventListener('click', () => document.getElementById('add-barber-modal').classList.add('active'));
        document.getElementById('save-barber-btn').addEventListener('click', async () => {
            const name = document.getElementById('new-barber-name').value.trim();
            if (name) {
                await addDoc(collection(db, barbersCollectionPath), { name, status: 'available' });
                document.getElementById('add-barber-modal').classList.remove('active');
            } else document.getElementById('add-barber-error').textContent = "O nome n√£o pode ser vazio.";
        });
        document.getElementById('confirm-remove-barber-btn').addEventListener('click', async () => {
            if(barberToRemoveId) {
                await deleteDoc(doc(db, barbersCollectionPath, barberToRemoveId));
                document.getElementById('remove-barber-modal').classList.remove('active');
            }
        });
        document.getElementById('clear-history-btn').addEventListener('click', () => document.getElementById('clear-history-modal').classList.add('active'));
        document.getElementById('confirm-clear-history-btn').addEventListener('click', async () => {
            const snapshot = await getDocs(collection(db, historyCollectionPath));
            await Promise.all(snapshot.docs.map(d => deleteDoc(d.ref)));
            document.getElementById('clear-history-modal').classList.remove('active');
        });

        // --- L√ìGICA DO QUIOSQUE ---
        document.getElementById('kiosk-join-queue-btn').addEventListener('click', async (e) => {
            const btn = e.target;
            const nameInput = document.getElementById('kiosk-customer-name');
            const feedbackEl = document.getElementById('kiosk-customer-feedback');
            const barberSelect = document.getElementById('kiosk-preferred-barber');
            const name = nameInput.value.trim();
            if (name) {
                btn.disabled = true;
                try {
                    await addDoc(collection(db, queueCollectionPath), { 
                        name, 
                        timestamp: serverTimestamp(),
                        preferredBarberId: barberSelect.value,
                        preferredBarberName: barberSelect.options[barberSelect.selectedIndex].text
                    });
                    feedbackEl.textContent = 'Sucesso! Voc√™ est√° na fila.';
                    nameInput.value = '';
                    updateWaitTime(true); 
                } catch (error) {
                    feedbackEl.textContent = 'Erro ao conectar.';
                } finally {
                    setTimeout(() => { btn.disabled = false; feedbackEl.textContent = ''; }, 4000);
                }
            } else {
                feedbackEl.textContent = 'Por favor, digite seu nome.';
            }
        });

        function updateWaitTime(forceShow = false) {
            const display = document.getElementById('wait-time-display');
            if (!isEstimationEnabled) {
                display.textContent = '';
                return;
            }
            if(forceShow) {
                const peopleInFront = currentQueueSize;
                const waitTime = Math.ceil((peopleInFront + 1) / Math.max(1, availableBarbersCount)) * dynamicAverageTime;
                display.textContent = `Tempo de espera: aprox. ${waitTime} minutos.`;
                setTimeout(() => { display.textContent = '' }, 5000);
            }
        }
        
        // --- LISTENERS (INICIAM COM A P√ÅGINA) ---
        function startListeners() {
            onSnapshot(query(collection(db, barbersCollectionPath), orderBy("name")), (snapshot) => {
                const selectEl = document.getElementById('kiosk-preferred-barber');
                selectEl.innerHTML = '<option value="any">Qualquer Barbeiro</option>';
                barbersCache = {};
                let localAvailableBarbers = 0;
                snapshot.forEach(doc => {
                    const barber = { id: doc.id, ...doc.data() };
                    barbersCache[barber.id] = barber.name;
                    if (barber.status !== 'busy') {
                        localAvailableBarbers++;
                        const option = document.createElement('option');
                        option.value = barber.id;
                        option.textContent = barber.name;
                        selectEl.appendChild(option);
                    }
                });
                availableBarbersCount = localAvailableBarbers;
            });

            onSnapshot(query(collection(db, queueCollectionPath), orderBy("timestamp")), (snapshot) => {
                const listTV = document.getElementById('queue-list-display');
                const nextAdmin = document.getElementById('next-in-queue-barber');
                listTV.innerHTML = '';
                
                snapshot.docs.forEach((doc, i) => {
                    const data = doc.data();
                    let preferenceText = '';
                    if (data.preferredBarberId && data.preferredBarberId !== 'any') {
                        preferenceText = `<span class="text-xs text-amber-300 ml-2">(Pref: ${data.preferredBarberName})</span>`;
                    }
                    listTV.innerHTML += `<li class="bg-gray-700 p-3 rounded-lg flex items-center text-xl">
                        <span class="text-amber-400 font-bold text-2xl mr-4">${i + 1}¬∫</span>
                        <span>${data.name}</span>
                        ${preferenceText}
                    </li>`;
                });

                currentQueueSize = snapshot.size;
                const hasCustomers = currentQueueSize > 0;
                nextAdmin.textContent = hasCustomers ? snapshot.docs[0].data().name : 'Ningu√©m';
                if (!hasCustomers) listTV.innerHTML = '<p class="text-center text-gray-400">A fila est√° vazia.</p>';

                updateBarberButtonsState(hasCustomers);
            });

            onSnapshot(query(collection(db, barbersCollectionPath), orderBy("name")), (snapshot) => {
                const listTV = document.getElementById('serving-now-list');
                const panelAdmin = document.getElementById('barbers-panel');
                listTV.innerHTML = ''; panelAdmin.innerHTML = '';
                if(snapshot.empty) panelAdmin.innerHTML = '<p class="col-span-full text-center text-gray-400">Nenhum barbeiro cadastrado.</p>';
                
                snapshot.forEach(doc => {
                    const barber = { id: doc.id, ...doc.data() };
                    if (barber.status === 'busy') {
                        listTV.innerHTML += `<div class="bg-gray-700 p-4 rounded-lg flex justify-between items-center text-xl"><span class="font-semibold">${barber.servingCustomerName}</span><span class="text-sm text-amber-400">${barber.name}</span></div>`;
                    }
                    const card = document.createElement('div');
                    card.className = `barber-card bg-gray-800 p-6 rounded-xl border-2 ${barber.status === 'busy' ? 'border-red-600' : 'border-green-500'}`;
                    card.innerHTML = `<div class="flex justify-between items-start mb-2"><h3 class="text-2xl font-bold">${barber.name}</h3><button data-barber-id="${barber.id}" data-barber-name="${barber.name}" class="remove-barber-btn text-xl leading-none text-gray-500 hover:text-red-500">&times;</button></div><p class="text-sm text-gray-400">Status:</p><p class="font-semibold text-lg ${barber.status === 'busy' ? 'text-red-400' : 'text-green-400'}">${barber.status === 'busy' ? `Atendendo: ${barber.servingCustomerName}` : 'Livre'}</p><div class="grid grid-cols-2 gap-2 mt-4"><button data-barber-id="${barber.id}" class="call-next-btn bg-green-600 hover:bg-green-700 font-semibold py-2 rounded-lg">Pr√≥ximo</button><button data-barber-id="${barber.id}" class="call-specific-btn bg-blue-600 hover:bg-blue-700 font-semibold py-2 rounded-lg">Da Fila</button><button data-barber-id="${barber.id}" class="finish-work-btn col-span-2 bg-red-600 hover:bg-red-700 font-semibold py-2 rounded-lg mt-2">Finalizar</button></div>`;
                    panelAdmin.appendChild(card);
                });
                if(!listTV.innerHTML) listTV.innerHTML = '<p class="text-gray-400 text-center">Nenhum cliente em atendimento.</p>';
                addEventListenersToAdminButtons();
                updateBarberButtonsState(currentQueueSize > 0);
            });

            onSnapshot(query(collection(db, historyCollectionPath), orderBy("completedAt", "desc")), (snapshot) => {
                const container = document.getElementById('history-list-container');
                const statsEl = document.getElementById('history-stats');
                const today = new Date().setHours(0, 0, 0, 0);
                const todaysDocs = snapshot.docs.filter(doc => doc.data().completedAt?.toDate().setHours(0,0,0,0) === today);
                
                const totalToday = todaysDocs.length;
                const byBarber = todaysDocs.reduce((acc, doc) => {
                    const name = doc.data().barberName;
                    acc[name] = (acc[name] || 0) + 1;
                    return acc;
                }, {});
                
                let statsHTML = `<p>Total de Hoje: <span class="font-bold text-amber-400">${totalToday}</span></p>`;
                if(Object.keys(byBarber).length > 0) statsHTML += `<p class="text-sm">Por Barbeiro: ${Object.entries(byBarber).map(([name, count]) => `${name} (${count})`).join(', ')}</p>`;
                
                const durations = snapshot.docs.map(doc => doc.data().durationInMinutes).filter(d => d > 0);
                if (durations.length > 0) {
                    dynamicAverageTime = Math.round(durations.reduce((sum, d) => sum + d, 0) / durations.length);
                    statsHTML += `<p class="text-sm">Tempo M√©dio de Atendimento: ${dynamicAverageTime} min</p>`;
                }

                statsEl.innerHTML = statsHTML;
                container.innerHTML = snapshot.empty ? '<p class="text-center text-gray-400">Nenhum atendimento finalizado.</p>' : '<table class="w-full text-left"><thead><tr class="border-b border-gray-600"><th class="p-3 text-amber-500">Cliente</th><th class="p-3 text-amber-500">Barbeiro</th><th class="p-3 text-amber-500 text-right">Hor√°rio</th></tr></thead><tbody></tbody></table>';
                if(!snapshot.empty) {
                    const tbody = container.querySelector('tbody');
                    snapshot.forEach(doc => {
                        const h = doc.data();
                        tbody.innerHTML += `<tr class="border-t border-gray-700"><td class="p-3">${h.customerName}</td><td class="p-3">${h.barberName}</td><td class="p-3 text-right">${h.completedAt?.toDate().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}) || ''}</td></tr>`;
                    });
                }
            });
            document.getElementById('loading-overlay').style.display = 'none';
        }
        
        function updateBarberButtonsState(queueIsNotEmpty) {
            document.querySelectorAll('.barber-card').forEach(card => {
                const isBusy = card.querySelector('.text-red-400') !== null;
                card.querySelectorAll('button').forEach(btn => {
                    if (btn.classList.contains('call-next-btn') || btn.classList.contains('call-specific-btn')) btn.disabled = isBusy || !queueIsNotEmpty;
                    if (btn.classList.contains('finish-work-btn')) btn.disabled = !isBusy;
                    if (btn.classList.contains('remove-barber-btn')) btn.disabled = isBusy;
                });
            });
        }

        function addEventListenersToAdminButtons() {
            document.querySelectorAll('.call-next-btn').forEach(btn => btn.onclick = (e) => callNextCustomer(e.target.dataset.barberId));
            document.querySelectorAll('.finish-work-btn').forEach(btn => btn.onclick = (e) => finishWork(e.target.dataset.barberId));
            document.querySelectorAll('.call-specific-btn').forEach(btn => btn.onclick = (e) => requestSpecificCustomer(e.target.dataset.barberId));
            document.querySelectorAll('.remove-barber-btn').forEach(btn => btn.onclick = (e) => {
                barberToRemoveId = e.target.dataset.barberId;
                document.getElementById('remove-barber-text').textContent = `Remover ${e.target.dataset.barberName}?`;
                document.getElementById('remove-barber-modal').classList.add('active');
            });
        }
        
        async function callNextCustomer(barberId) {
            const q = query(collection(db, queueCollectionPath), orderBy("timestamp"));
            const snap = await getDocs(q);
            if (snap.empty) return;

            for (const customerDoc of snap.docs) {
                const customerData = customerDoc.data();
                if (customerData.preferredBarberId === 'any' || customerData.preferredBarberId === barberId) {
                    await callSpecificCustomer(barberId, customerDoc.id, customerData.name);
                    return; // Sai da fun√ß√£o ap√≥s chamar o cliente
                }
            }
            alert(`N√£o h√° clientes na fila para voc√™ no momento.`);
        }

        async function requestSpecificCustomer(barberId) {
            activeBarberId = barberId;
            const modal = document.getElementById('specific-customer-modal');
            const listEl = document.getElementById('specific-customer-list');
            listEl.innerHTML = '<p class="text-center">Carregando...</p>';
            modal.classList.add('active');
            const snap = await getDocs(query(collection(db, queueCollectionPath), orderBy("timestamp")));
            listEl.innerHTML = snap.empty ? '<p class="text-gray-400">A fila est√° vazia.</p>' : '';
            snap.forEach((doc, i) => {
                const c = doc.data();
                const prefText = (c.preferredBarberId && c.preferredBarberId !== 'any') ? ` (Pref: ${c.preferredBarberName})` : '';
                const item = document.createElement('div');
                item.className = 'specific-customer-item bg-gray-700 p-3 rounded-lg flex items-center cursor-pointer';
                item.innerHTML = `<span class="text-amber-400 font-bold text-lg mr-4">${i + 1}¬∫</span><span>${c.name}${prefText}</span>`;
                item.onclick = () => callSpecificCustomer(activeBarberId, doc.id, c.name);
                listEl.appendChild(item);
            });
        }

        async function callSpecificCustomer(barberId, customerId, customerName) {
            document.getElementById('notification-sound').play();
            allModals.forEach(m => m.classList.remove('active'));
            await updateDoc(doc(db, barbersCollectionPath, barberId), { status: 'busy', servingCustomerName: customerName, servingCustomerId: customerId, servingSince: serverTimestamp() });
            await deleteDoc(doc(db, queueCollectionPath, customerId));
        }

        async function finishWork(barberId) {
            const barberRef = doc(db, barbersCollectionPath, barberId);
            const barberSnap = await getDoc(barberRef);
            if (barberSnap.exists()) {
                const d = barberSnap.data();
                if (d.status === 'busy' && d.servingSince) {
                    const durationInMinutes = Math.round((new Date().getTime() - d.servingSince.toDate().getTime()) / 60000);
                    await addDoc(collection(db, historyCollectionPath), { 
                        customerName: d.servingCustomerName, 
                        barberName: d.name, 
                        completedAt: serverTimestamp(),
                        durationInMinutes: durationInMinutes > 0 ? durationInMinutes : 1 
                    });
                }
                await updateDoc(barberRef, { status: 'available', servingCustomerName: null, servingCustomerId: null, servingSince: null });
            }
        }

        startListeners();
    </script>
</body>
</html>
