<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Fila - Amaral Barbearia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-anton { font-family: 'Anton', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .barber-card, .specific-customer-item { transition: all 0.2s ease-in-out; }
        .specific-customer-item:hover { background-color: #d97706; }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
        <div class="text-center"><svg class="animate-spin h-10 w-10 text-amber-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p>Carregando...</p></div>
    </div>
    
    <!-- Bot√£o de Acesso Admin -->
    <button id="show-login-btn" class="fixed top-4 right-4 bg-gray-700 p-3 rounded-full hover:bg-gray-600 z-30">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-500"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
    </button>
    
    <!-- Modal de Senha -->
    <div id="password-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-40">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm border-t-4 border-amber-500">
            <h3 class="text-2xl font-bold text-center mb-6">Acesso Administrativo</h3>
            <div class="space-y-4">
                <input type="password" id="password-input" placeholder="Senha" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-amber-500">
                <p id="password-error" class="text-red-500 text-sm text-center h-4"></p>
                <button id="submit-password-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-black font-bold py-3 px-4 rounded-lg">Entrar</button>
                <button class="cancel-modal-btn w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg mt-2">Cancelar</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8 text-center">
            <h1 class="font-anton text-6xl tracking-wider text-amber-500">AMARAL BARBEARIA</h1>
        </header>

        <main>
            <!-- TELA DA TV (INICIAL) -->
            <div id="tv-view" class="view active">
                 <p class="text-center text-gray-400 mb-8">Acompanhe a Fila</p>
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border-t-4 border-amber-500 w-full"><h2 class="text-2xl font-bold mb-4 border-b-2 border-amber-500 pb-2 text-white">üíà Em Atendimento</h2><div id="serving-now-list" class="space-y-4"></div></div>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border-t-4 border-amber-500 w-full"><h2 class="text-2xl font-bold mb-4 border-b-2 border-amber-500 pb-2 text-white">‚è≥ Fila de Espera</h2><ol id="queue-list-display" class="space-y-3"></ol></div>
                </div>
            </div>
            
            <!-- TELA DE ENTRAR NA FILA (QUIOSQUE) -->
            <div id="kiosk-view" class="view">
                 <div class="w-full max-w-md mx-auto bg-gray-800 p-8 sm:p-12 rounded-xl shadow-2xl border-t-4 border-amber-500 text-center">
                    <h2 class="text-2xl font-bold text-center mb-4 text-white">Bem-vindo!</h2>
                    <p class="text-center text-gray-400 mb-6">Digite seu nome para entrar na fila de espera.</p>
                    <div class="space-y-4">
                        <input type="text" id="kiosk-customer-name" placeholder="Seu nome completo" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <button id="kiosk-join-queue-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-black font-bold py-4 px-4 rounded-lg shadow-lg text-xl">Entrar na Fila</button>
                    </div>
                    <p id="kiosk-customer-feedback" class="text-center text-green-400 mt-6 h-6 text-lg"></p>
                </div>
            </div>

            <!-- TELA DO ADMIN -->
            <div id="admin-view" class="view">
                <p class="text-center text-gray-400 mb-4">Painel de Controle</p>
                <div class="text-center mb-8 space-x-4">
                     <button id="go-to-tv-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">Ver Tela da TV</button>
                     <button id="go-to-kiosk-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Tela de Cliente</button>
                     <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">Sair do Painel</button>
                </div>
                
                <div class="mt-16">
                    <div class="flex justify-center items-center mb-6 gap-4">
                         <h3 class="text-3xl font-bold text-amber-500 text-center">Hist√≥rico</h3>
                         <button id="clear-history-btn" class="bg-red-800 hover:bg-red-700 text-white font-semibold p-2 rounded-full" title="Limpar Hist√≥rico">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                         </button>
                    </div>
                    <div id="history-list-container" class="bg-gray-800 p-6 rounded-xl shadow-2xl border-t-4 border-amber-500 max-h-96 overflow-y-auto"></div>
                </div>

                <div class="mt-16">
                    <div class="text-center mb-6"><h2 class="text-3xl font-bold text-amber-500">Gerenciar Barbeiros</h2><p class="text-gray-400">Pr√≥ximo cliente: <span id="next-in-queue-barber" class="font-bold text-xl text-white">Ningu√©m</span></p></div>
                    <div class="text-center mb-8"><button id="add-barber-btn" class="bg-amber-500 hover:bg-amber-600 text-black font-bold py-2 px-6 rounded-lg">Adicionar Barbeiro</button></div>
                    <div id="barbers-panel" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modais -->
    <div id="specific-customer-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-40"><div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md border-t-4 border-amber-500"><h3 class="text-2xl font-bold text-center mb-6">Escolher Cliente da Fila</h3><div id="specific-customer-list" class="space-y-2 max-h-64 overflow-y-auto mb-6"></div><button class="cancel-modal-btn w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg">Cancelar</button></div></div>
    <div id="add-barber-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-40"><div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm border-t-4 border-amber-500"><h3 class="text-2xl font-bold text-center mb-6">Adicionar Novo Barbeiro</h3><div class="space-y-4"><input type="text" id="new-barber-name" placeholder="Nome do Barbeiro" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white"><p id="add-barber-error" class="text-red-500 text-sm text-center h-4"></p><button id="save-barber-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">Salvar</button><button class="cancel-modal-btn w-full bg-gray-600 hover:bg-gray-700 font-semibold py-2 px-4 rounded-lg">Cancelar</button></div></div></div>
    <div id="remove-barber-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-40"><div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm border-t-4 border-amber-500"><h3 class="text-2xl font-bold text-center mb-6">Confirmar Remo√ß√£o</h3><p id="remove-barber-text" class="text-center text-gray-300 mb-6"></p><div class="flex gap-4"><button class="cancel-modal-btn w-full bg-gray-600 hover:bg-gray-700 font-semibold py-2 px-4 rounded-lg">Cancelar</button><button id="confirm-remove-barber-btn" class="w-full bg-red-600 hover:bg-red-700 font-bold py-3 px-4 rounded-lg">Confirmar</button></div></div></div>
    <div id="clear-history-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-40"><div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm border-t-4 border-amber-500"><h3 class="text-2xl font-bold text-center mb-6">Confirmar A√ß√£o</h3><p class="text-center text-gray-300 mb-6">Tem certeza que deseja apagar TODO o hist√≥rico de atendimentos? Esta a√ß√£o n√£o pode ser desfeita.</p><div class="flex gap-4"><button class="cancel-modal-btn w-full bg-gray-600 hover:bg-gray-700 font-semibold py-2 px-4 rounded-lg">Cancelar</button><button id="confirm-clear-history-btn" class="w-full bg-red-600 hover:bg-red-700 font-bold py-3 px-4 rounded-lg">Apagar Hist√≥rico</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, onSnapshot, collection, query, orderBy, limit, addDoc, serverTimestamp, deleteDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDHSIP0Ko808esMuRt0AIQ0Ujhh6hL8ySo",
          authDomain: "barberamaral-e10a4.firebaseapp.com",
          projectId: "barberamaral-e10a4",
          storageBucket: "barberamaral-e10a4.appspot.com",
          messagingSenderId: "617102577968",
          appId: "1:617102577968:web:2caa50df50518ee2f578f5",
          measurementId: "G-66VFX9JERR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const queueCollectionPath = `artifacts/${firebaseConfig.projectId}/public/data/queue`;
        const barbersCollectionPath = `artifacts/${firebaseConfig.projectId}/public/data/barbers`;
        const historyCollectionPath = `artifacts/${firebaseConfig.projectId}/public/data/history`;

        // --- L√ìGICA DE ESTADO E NAVEGA√á√ÉO ---
        const ADMIN_PASSWORD = "AmaralAdmin"; 
        let isAdminAuthenticated = false;

        const passwordModal = document.getElementById('password-modal');
        const showLoginBtn = document.getElementById('show-login-btn');
        
        window.switchView = (viewId) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            showLoginBtn.style.display = (viewId === 'admin-view') ? 'none' : 'block';
        };

        showLoginBtn.addEventListener('click', () => {
            if (isAdminAuthenticated) {
                switchView('admin-view');
            } else {
                passwordModal.classList.add('active');
                document.getElementById('password-input').focus();
            }
        });

        document.getElementById('submit-password-btn').addEventListener('click', () => {
            const input = document.getElementById('password-input').value;
            if (input === ADMIN_PASSWORD) {
                isAdminAuthenticated = true;
                passwordModal.classList.remove('active');
                switchView('admin-view');
            } else {
                document.getElementById('password-error').textContent = 'Senha incorreta.';
            }
        });
        
        document.getElementById('logout-btn').addEventListener('click', () => {
            isAdminAuthenticated = false;
            switchView('tv-view');
        });
        
        document.getElementById('go-to-kiosk-btn').addEventListener('click', () => switchView('kiosk-view'));
        document.getElementById('go-to-tv-btn').addEventListener('click', () => switchView('tv-view'));

        // --- L√ìGICA DOS MODAIS ---
        const allModals = document.querySelectorAll('.modal');
        document.querySelectorAll('.cancel-modal-btn').forEach(btn => {
            btn.addEventListener('click', (e) => e.target.closest('.modal').classList.remove('active'));
        });
        
        let activeBarberId = null;
        let barberToRemoveId = null;

        document.getElementById('add-barber-btn').addEventListener('click', () => document.getElementById('add-barber-modal').classList.add('active'));

        document.getElementById('save-barber-btn').addEventListener('click', async () => {
            const name = document.getElementById('new-barber-name').value.trim();
            if (name) {
                await addDoc(collection(db, barbersCollectionPath), { name, status: 'available' });
                document.getElementById('add-barber-modal').classList.remove('active');
            } else {
                document.getElementById('add-barber-error').textContent = "O nome n√£o pode ser vazio.";
            }
        });

        document.getElementById('confirm-remove-barber-btn').addEventListener('click', async () => {
            if(barberToRemoveId) {
                await deleteDoc(doc(db, barbersCollectionPath, barberToRemoveId));
                document.getElementById('remove-barber-modal').classList.remove('active');
            }
        });
        
        document.getElementById('clear-history-btn').addEventListener('click', () => {
            document.getElementById('clear-history-modal').classList.add('active');
        });
        
        document.getElementById('confirm-clear-history-btn').addEventListener('click', async () => {
            const historyRef = collection(db, historyCollectionPath);
            const snapshot = await getDocs(historyRef);
            const deletePromises = [];
            snapshot.forEach(doc => deletePromises.push(deleteDoc(doc.ref)));
            await Promise.all(deletePromises);
            document.getElementById('clear-history-modal').classList.remove('active');
        });

        // --- L√ìGICA DO QUIOSQUE ---
        document.getElementById('kiosk-join-queue-btn').addEventListener('click', async (e) => {
            const btn = e.target;
            const nameInput = document.getElementById('kiosk-customer-name');
            const feedbackEl = document.getElementById('kiosk-customer-feedback');
            const name = nameInput.value.trim();
            if (name) {
                btn.disabled = true;
                try {
                    await addDoc(collection(db, queueCollectionPath), { name, timestamp: serverTimestamp() });
                    feedbackEl.textContent = 'Sucesso! Voc√™ est√° na fila.';
                    nameInput.value = '';
                } catch (error) {
                    feedbackEl.textContent = 'Erro ao conectar.';
                } finally {
                    setTimeout(() => { btn.disabled = false; feedbackEl.textContent = ''; }, 3000);
                }
            } else {
                feedbackEl.textContent = 'Por favor, digite seu nome.';
            }
        });
        
        // --- LISTENERS (INICIAM COM A P√ÅGINA) ---
        function startListeners() {
            // Fila (para TV e Admin)
            onSnapshot(query(collection(db, queueCollectionPath), orderBy("timestamp")), (snapshot) => {
                const listTV = document.getElementById('queue-list-display');
                const nextAdmin = document.getElementById('next-in-queue-barber');
                listTV.innerHTML = snapshot.empty ? '<p class="text-center text-gray-400">A fila est√° vazia.</p>' : '';
                snapshot.forEach((doc, i) => listTV.innerHTML += `<li class="bg-gray-700 p-3 rounded-lg flex items-center text-xl"><span class="text-amber-400 font-bold text-2xl mr-4">${i + 1}¬∫</span><span>${doc.data().name}</span></li>`);
                const hasCustomers = !snapshot.empty;
                nextAdmin.textContent = hasCustomers ? snapshot.docs[0].data().name : 'Ningu√©m';
                updateBarberButtonsState(hasCustomers);
            });

            // Atendimentos (para TV) e Barbeiros (para Admin)
            onSnapshot(query(collection(db, barbersCollectionPath), orderBy("name")), (snapshot) => {
                const listTV = document.getElementById('serving-now-list');
                const panelAdmin = document.getElementById('barbers-panel');
                listTV.innerHTML = ''; panelAdmin.innerHTML = '';
                let isAnyoneServing = false;
                if(snapshot.empty) panelAdmin.innerHTML = '<p class="col-span-full text-center text-gray-400">Nenhum barbeiro cadastrado.</p>';
                snapshot.forEach(doc => {
                    const barber = { id: doc.id, ...doc.data() };
                    if (barber.status === 'busy') {
                        isAnyoneServing = true;
                        listTV.innerHTML += `<div class="bg-gray-700 p-4 rounded-lg flex justify-between items-center text-xl"><span class="font-semibold">${barber.servingCustomerName}</span><span class="text-sm text-amber-400">${barber.name}</span></div>`;
                    }
                    const isBusy = barber.status === 'busy';
                    const card = document.createElement('div');
                    card.className = `barber-card bg-gray-800 p-6 rounded-xl border-2 ${isBusy ? 'border-red-600' : 'border-green-500'}`;
                    card.innerHTML = `<div class="flex justify-between items-start mb-2"><h3 class="text-2xl font-bold">${barber.name}</h3><button data-barber-id="${barber.id}" data-barber-name="${barber.name}" class="remove-barber-btn text-xl leading-none text-gray-500 hover:text-red-500">&times;</button></div><p class="text-sm text-gray-400">Status:</p><p class="font-semibold text-lg ${isBusy ? 'text-red-400' : 'text-green-400'}">${isBusy ? `Atendendo: ${barber.servingCustomerName}` : 'Livre'}</p><div class="grid grid-cols-2 gap-2 mt-4"><button data-barber-id="${barber.id}" class="call-next-btn bg-green-600 hover:bg-green-700 font-semibold py-2 rounded-lg">Pr√≥ximo</button><button data-barber-id="${barber.id}" class="call-specific-btn bg-blue-600 hover:bg-blue-700 font-semibold py-2 rounded-lg">Da Fila</button><button data-barber-id="${barber.id}" class="finish-work-btn col-span-2 bg-red-600 hover:bg-red-700 font-semibold py-2 rounded-lg mt-2">Finalizar</button></div>`;
                    panelAdmin.appendChild(card);
                });
                if(!isAnyoneServing) listTV.innerHTML = '<p class="text-gray-400 text-center">Nenhum cliente em atendimento.</p>';
                addEventListenersToAdminButtons();
                updateBarberButtonsState(document.getElementById('next-in-queue-barber').textContent !== 'Ningu√©m');
            });

            // Hist√≥rico (para Admin)
            onSnapshot(query(collection(db, historyCollectionPath), orderBy("completedAt", "desc")), (snapshot) => {
                const container = document.getElementById('history-list-container');
                container.innerHTML = snapshot.empty ? '<p class="text-center text-gray-400">Nenhum atendimento finalizado.</p>' : '<table class="w-full text-left"><thead><tr class="border-b border-gray-600"><th class="p-3 text-amber-500">Cliente</th><th class="p-3 text-amber-500">Barbeiro</th><th class="p-3 text-amber-500 text-right">Hor√°rio</th></tr></thead><tbody></tbody></table>';
                if(!snapshot.empty) {
                    const tbody = container.querySelector('tbody');
                    snapshot.forEach(doc => {
                        const h = doc.data();
                        tbody.innerHTML += `<tr class="border-t border-gray-700"><td class="p-3">${h.customerName}</td><td class="p-3">${h.barberName}</td><td class="p-3 text-right">${h.completedAt?.toDate().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}) || ''}</td></tr>`;
                    });
                }
            });
            document.getElementById('loading-overlay').style.display = 'none';
        }
        
        function updateBarberButtonsState(queueIsNotEmpty) {
            document.querySelectorAll('.barber-card').forEach(card => {
                const isBusy = card.querySelector('.text-red-400') !== null;
                card.querySelectorAll('button').forEach(btn => {
                    if (btn.classList.contains('call-next-btn') || btn.classList.contains('call-specific-btn')) btn.disabled = isBusy || !queueIsNotEmpty;
                    if (btn.classList.contains('finish-work-btn')) btn.disabled = !isBusy;
                    if (btn.classList.contains('remove-barber-btn')) btn.disabled = isBusy;
                });
            });
        }

        function addEventListenersToAdminButtons() {
            document.querySelectorAll('.call-next-btn').forEach(btn => btn.onclick = (e) => callNextCustomer(e.target.dataset.barberId));
            document.querySelectorAll('.finish-work-btn').forEach(btn => btn.onclick = (e) => finishWork(e.target.dataset.barberId));
            document.querySelectorAll('.call-specific-btn').forEach(btn => btn.onclick = (e) => requestSpecificCustomer(e.target.dataset.barberId));
            document.querySelectorAll('.remove-barber-btn').forEach(btn => btn.onclick = (e) => {
                barberToRemoveId = e.target.dataset.barberId;
                document.getElementById('remove-barber-text').textContent = `Remover ${e.target.dataset.barberName}?`;
                document.getElementById('remove-barber-modal').classList.add('active');
            });
        }
        
        async function callNextCustomer(barberId) {
            const snap = await getDocs(query(collection(db, queueCollectionPath), orderBy("timestamp"), limit(1)));
            if (!snap.empty) await callSpecificCustomer(barberId, snap.docs[0].id, snap.docs[0].data().name);
        }

        async function requestSpecificCustomer(barberId) {
            activeBarberId = barberId;
            const modal = document.getElementById('specific-customer-modal');
            const listEl = document.getElementById('specific-customer-list');
            listEl.innerHTML = '<p class="text-center">Carregando...</p>';
            modal.classList.add('active');
            const snap = await getDocs(query(collection(db, queueCollectionPath), orderBy("timestamp")));
            listEl.innerHTML = snap.empty ? '<p class="text-gray-400">A fila est√° vazia.</p>' : '';
            snap.forEach((doc, i) => {
                const c = doc.data();
                const item = document.createElement('div');
                item.className = 'specific-customer-item bg-gray-700 p-3 rounded-lg flex items-center cursor-pointer';
                item.innerHTML = `<span class="text-amber-400 font-bold text-lg mr-4">${i + 1}¬∫</span><span>${c.name}</span>`;
                item.onclick = () => callSpecificCustomer(activeBarberId, doc.id, c.name);
                listEl.appendChild(item);
            });
        }

        async function callSpecificCustomer(barberId, customerId, customerName) {
            allModals.forEach(m => m.classList.remove('active'));
            await updateDoc(doc(db, barbersCollectionPath, barberId), { status: 'busy', servingCustomerName: customerName, servingCustomerId: customerId });
            await deleteDoc(doc(db, queueCollectionPath, customerId));
        }

        async function finishWork(barberId) {
            const barberRef = doc(db, barbersCollectionPath, barberId);
            const barberSnap = await getDoc(barberRef);
            if (barberSnap.exists()) {
                const d = barberSnap.data();
                if (d.status === 'busy') await addDoc(collection(db, historyCollectionPath), { customerName: d.servingCustomerName, barberName: d.name, completedAt: serverTimestamp() });
                await updateDoc(barberRef, { status: 'available', servingCustomerName: null, servingCustomerId: null });
            }
        }

        startListeners();
    </script>
</body>
</html>
